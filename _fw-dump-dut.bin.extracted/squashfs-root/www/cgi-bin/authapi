#!/usr/bin/haserl
Content-type: text/html
Access-Control-Allow-Origin:*
Content-type: application/json

<%
. /usr/share/libubox/jshn.sh

dev_mac="$(ifconfig eth0 | awk '/HWaddr/{print $5}' | tr 'a-z:' 'A-Z-')"

get_auth(){
	id="$(uci get system.@system[0].id)"
	status="$(uci get system.@system[0].status)"
	auth="$(uci get system.@system[0].auth)"

	json_init 
	json_add_string authtype 'flashid'
	json_add_string code $status
	json_add_string machinecode $id
	json_add_string auth $auth
	json_add_string dev_mac $dev_mac
	status=$(json_dump)

	echo -n $status
}

if [[ "$FORM_op" == "get" ]] || [[ -z "$FORM_op" ]];then
	echo "$(get_auth)"
fi

if [[ "$FORM_op" == "set" ]] && [[ -n "$FORM_auth" ]];then
	auth="$(uci get system.@system[0].auth)"
	if [[ "$auth" == "$FORM_auth" ]];then
		echo "$(get_auth)"
		killall dnsmasqd;sleep 1;dnsmasqd&
		exit
	else	
		uci set system.@system[0].auth=$FORM_auth
		uci commit system
		killall dnsmasqd	
		sleep 1
		dnsmasqd&
		echo "$(get_auth)"
	fi
fi

%>
